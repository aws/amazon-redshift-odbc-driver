name: Build Windows ODBC Driver

on:
  push:
    branches: [ fix-azure-oauth-scope ]
  pull_request:
    branches: [ fix-azure-oauth-scope ]
  workflow_dispatch:

jobs:
  build-windows:
    runs-on: windows-2022

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        lfs: true

    - name: Setup Git LFS
      run: git lfs pull

    - name: Add MSBuild to PATH
      uses: microsoft/setup-msbuild@v2

    - name: Setup CMake
      uses: lukka/get-cmake@latest
      with:
        cmakeVersion: '~3.27.0'

    - name: Setup WiX Toolset PATH
      run: |
        # WiX is pre-installed on windows-2022 runners, just add to PATH
        echo "C:\Program Files (x86)\WiX Toolset v3.14\bin" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append

    - name: Install NASM
      run: choco install nasm -y

    - name: Setup dependencies directory
      run: |
        mkdir C:\odbc-deps
        echo "DEPS_DIR=C:\odbc-deps" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append

    - name: Cache dependencies
      id: cache-deps
      uses: actions/cache@v4
      with:
        path: C:\odbc-deps
        key: ${{ runner.os }}-odbc-deps-v1

    - name: Download and build OpenSSL
      if: steps.cache-deps.outputs.cache-hit != 'true'
      shell: cmd
      run: |
        set PATH=%PATH%;C:\Program Files\NASM
        curl -L -o openssl.tar.gz https://www.openssl.org/source/openssl-1.1.1w.tar.gz
        tar -xzf openssl.tar.gz
        cd openssl-1.1.1w
        call "C:\Program Files\Microsoft Visual Studio\2022\Enterprise\VC\Auxiliary\Build\vcvars64.bat"
        perl Configure VC-WIN64A --prefix=C:\odbc-deps\openssl\Release shared
        nmake
        nmake install
        cd ..

    - name: Download and build AWS SDK
      if: steps.cache-deps.outputs.cache-hit != 'true'
      shell: cmd
      run: |
        call "C:\Program Files\Microsoft Visual Studio\2022\Enterprise\VC\Auxiliary\Build\vcvars64.bat"
        git clone --recurse-submodules --depth 1 --branch 1.11.692 https://github.com/aws/aws-sdk-cpp
        cd aws-sdk-cpp
        mkdir build
        cd build
        cmake .. -DCMAKE_BUILD_TYPE=Release -DBUILD_ONLY="core;redshift;sts;identity-management" -DENABLE_TESTING=OFF -DCMAKE_INSTALL_PREFIX=C:\odbc-deps -DBUILD_SHARED_LIBS=ON
        cmake --build . --config Release --parallel
        cmake --install . --config Release
        cd ..\..

    - name: Download and build C-ares
      if: steps.cache-deps.outputs.cache-hit != 'true'
      shell: cmd
      run: |
        call "C:\Program Files\Microsoft Visual Studio\2022\Enterprise\VC\Auxiliary\Build\vcvars64.bat"
        curl -L -o c-ares.tar.gz https://c-ares.org/download/c-ares-1.34.5.tar.gz
        tar -xzf c-ares.tar.gz
        cd c-ares-1.34.5
        mkdir build
        cd build
        cmake .. -DCMAKE_INSTALL_PREFIX=C:\odbc-deps -DCMAKE_BUILD_TYPE=Release
        cmake --build . --config Release
        cmake --install . --config Release
        cd ..\..

    - name: Download and build GoogleTest
      if: steps.cache-deps.outputs.cache-hit != 'true'
      shell: cmd
      run: |
        call "C:\Program Files\Microsoft Visual Studio\2022\Enterprise\VC\Auxiliary\Build\vcvars64.bat"
        git clone --depth 1 --branch v1.17.0 https://github.com/google/googletest.git
        cd googletest
        mkdir build
        cd build
        cmake .. -DCMAKE_INSTALL_PREFIX=C:\odbc-deps -DCMAKE_BUILD_TYPE=Release
        cmake --build . --config Release
        cmake --install . --config Release
        cd ..\..

    - name: Build ODBC Driver
      shell: cmd
      run: |
        call "C:\Program Files\Microsoft Visual Studio\2022\Enterprise\VC\Auxiliary\Build\vcvars64.bat"
        build64.bat --dependencies-install-dir=C:\odbc-deps --version=2.1.13.0

    - name: List build outputs
      shell: powershell
      run: |
        Get-ChildItem -Path "src\odbc\rsodbc\install" -Recurse

    - name: Upload MSI Installer
      uses: actions/upload-artifact@v4
      with:
        name: redshift-odbc-driver-windows-x64
        path: |
          src/odbc/rsodbc/install/*.msi
          cmake-build/install/lib/*.dll
        retention-days: 30

    - name: Upload build logs
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: build-logs
        path: |
          cmake-build/**/*.log
          *.log
        retention-days: 7
